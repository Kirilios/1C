ВЫБРАТЬ
    Корректировка.Документ КАК Документ,

    // Количество товаров
    СУММА(
        ВЫБОР
            КОГДА Корректировка.ЭтоТовар
                ТОГДА Корректировка.Количество
            ИНАЧЕ 0
        КОНЕЦ
    ) КАК КоличествоТоваров,

    // Количество услуг
    СУММА(
        ВЫБОР
            КОГДА Корректировка.ЭтоУслуга
                ТОГДА Корректировка.Количество
            ИНАЧЕ 0
        КОНЕЦ
    ) КАК КоличествоУслуг,

    // Итоговое количество по правилу:
    // если есть услуги → вернуть количество услуг
    // иначе → количество товаров
    ВЫБОР
        КОГДА СУММА(
                ВЫБОР
                    КОГДА Корректировка.ЭтоУслуга
                        ТОГДА Корректировка.Количество
                    ИНАЧЕ 0
                КОНЕЦ
             ) > 0
            ТОГДА СУММА(
                    ВЫБОР
                        КОГДА Корректировка.ЭтоУслуга
                            ТОГДА Корректировка.Количество
                        ИНАЧЕ 0
                    КОНЕЦ
                )
        ИНАЧЕ
            СУММА(
                ВЫБОР
                    КОГДА Корректировка.ЭтоТовар
                        ТОГДА Корректировка.Количество
                    ИНАЧЕ 0
                КОНЕЦ
            )
    КОНЕЦ КАК ИтоговоеКоличество

ИЗ
    (ВЫБРАТЬ
         КорректировкаТовары.Документ КАК Документ,
         КорректировкаТовары.Количество КАК Количество,
         ИСТИНА КАК ЭтоТовар,
         ЛОЖЬ КАК ЭтоУслуга
     ИЗ
         Документ.КорректировкаРеализации.Товары КАК КорректировкаТовары

     ОБЪЕДИНИТЬ ВСЕ

     ВЫБРАТЬ
         КорректировкаУслуг.Документ,
         КорректировкаУслуг.Количество,
         ЛОЖЬ КАК ЭтоТовар,
         ИСТИНА КАК ЭтоУслуга
     ИЗ
         Документ.КорректировкаРеализации.Услуги КАК КорректировкаУслуг
    ) КАК Корректировка

СГРУППИРОВАТЬ ПО
    Корректировка.Документ;
