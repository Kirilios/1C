ВЫБРАТЬ
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа,
    СУММА(РеализацияКоличество) КАК РеализацияКоличество,
    СУММА(РеализацияСумма) КАК РеализацияСумма,
    СУММА(ФактКоличество) КАК ФактКоличество,
    СУММА(ФактСумма) КАК ФактСумма,
    СУММА(КорректировкаКоличество) КАК КорректировкаКоличество,
    СУММА(КорректировкаСумма) КАК КорректировкаСумма
ИЗ
(
    //----- Блок 1: Реализация + Факт
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
        Реализация.Контрагент КАК Контрагент,
        Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто) КАК НоменклатурнаяГруппа,
        СУММА(ВЫБОР
                КОГДА ЕСТЬNULL(РТУТовары.Сумма,0) > 0
                    ТОГДА ЕСТЬNULL(РТУТовары.Количество,0)
                ИНАЧЕ 0
            КОНЕЦ + ЕСТЬNULL(РТУУслуг.Количество,0)) КАК РеализацияКоличество,
        СУММА(ЕСТЬNULL(РТУТовары.Сумма,0) + ЕСТЬNULL(РТУУслуг.Сумма,0)) КАК РеализацияСумма,
        ЕСТЬNULL(Факт.ФактКоличество,0) КАК ФактКоличество,
        ЕСТЬNULL(Факт.ФактСумма,0) КАК ФактСумма,
        0 КАК КорректировкаКоличество,
        0 КАК КорректировкаСумма
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
            ПО Реализация.Ссылка = РТУТовары.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
            ПО Реализация.Ссылка = РТУУслуг.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ (
                ВЫБРАТЬ
                    НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ) КАК Дата,
                    ФактическиеДанные.Контрагент КАК Контрагент,
                    ФактическиеДанные.ДоговорКонтрагента КАК ДоговорКонтрагента,
                    ФактическиеДанные.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
                    СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
                    СУММА(ФактическиеДанные.Сумма) КАК ФактСумма
                ИЗ
                    Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
                ГДЕ
                    ФактическиеДанные.Ссылка.Проведен
                    И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
                    И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
                СГРУППИРОВАТЬ ПО
                    НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ),
                    ФактическиеДанные.Контрагент,
                    ФактическиеДанные.ДоговорКонтрагента,
                    ФактическиеДанные.НоменклатурнаяГруппа
            ) КАК Факт
            ПО (НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) = Факт.Дата)
                И (Реализация.Контрагент = Факт.Контрагент)
                И (Реализация.ДоговорКонтрагента = Факт.ДоговорКонтрагента)
                И (ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто) = Факт.НоменклатурнаяГруппа)
    ГДЕ
        Реализация.Проведен
        И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    СГРУППИРОВАТЬ ПО
        Реализация.Дата,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто)
    
    ОБЪЕДИНИТЬ ВСЕ
    
    //----- Блок 2: Корректировка
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ),
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        КорректировкаТовары.НоменклатурнаяГруппа,
        0 КАК РеализацияКоличество,
        0 КАК РеализацияСумма,
        0 КАК ФактКоличество,
        0 КАК ФактСумма,
        СУММА(ВЫБОР
                КОГДА КорректировкаУслуги.Количество > 0
                    ТОГДА КорректировкаУслуги.Количество
                ИНАЧЕ КорректировкаТовары.Количество
            КОНЕЦ) КАК КорректировкаКоличество,
        СУММА(КорректировкаТовары.СуммаКорректировки + КорректировкаУслуги.СуммаКорректировки) КАК КорректировкаСумма
    ИЗ
        Документ.КорректировкаРеализации КАК Корректировка
            ЛЕВОЕ СОЕДИНЕНИЕ (
                ВЫБРАТЬ
                    Товары.Ссылка КАК Ссылка,
                    Товары.Субконто КАК НоменклатурнаяГруппа,
                    СУММА(Товары.Количество) КАК Количество,
                    СУММА(ВЫБОР
                            КОГДА Товары.СуммаДоИзменения - Товары.Сумма < 0
                                ТОГДА Товары.Сумма - Товары.СуммаДоИзменения
                            ИНАЧЕ Товары.СуммаДоИзменения - Товары.Сумма
                        КОНЕЦ) КАК СуммаКорректировки
                ИЗ
                    Документ.КорректировкаРеализации.Товары КАК Товары
                СГРУППИРОВАТЬ ПО
                    Товары.Ссылка,
                    Товары.Субконто
            ) КАК КорректировкаТовары
            ПО Корректировка.Ссылка = КорректировкаТовары.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ (
                ВЫБРАТЬ
                    Услуги.Ссылка КАК Ссылка,
                    СУММА(Услуги.Количество) КАК Количество,
                    СУММА(ВЫБОР
                            КОГДА Услуги.СуммаДоИзменения - Услуги.Сумма < 0
                                ТОГДА Услуги.Сумма - Услуги.СуммаДоИзменения
                            ИНАЧЕ Услуги.СуммаДоИзменения - Услуги.Сумма
                        КОНЕЦ) КАК СуммаКорректировки
                ИЗ
                    Документ.КорректировкаРеализации.Услуги КАК Услуги
                СГРУППИРОВАТЬ ПО
                    Услуги.Ссылка
            ) КАК КорректировкаУслуги
            ПО Корректировка.Ссылка = КорректировкаУслуги.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
            ПО Корректировка.ДокументРеализации = Реализация.Ссылка
    ГДЕ
        Корректировка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
) КАК ОбъединенныеДанные
СГРУППИРОВАТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа
УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента
