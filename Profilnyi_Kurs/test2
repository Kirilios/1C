ВЫБРАТЬ
    ФактическиеДанные.Период КАК Период,
    ФактическиеДанные.ДоговорКонтрагента КАК Договор,
    ФактическиеДанные.Контрагент КАК Контрагент,
    ФактическиеДанные.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
    СУММА(ФактическиеДанные.Количество) КАК Количество,
    СУММА(ФактическиеДанные.Сумма) КАК Сумма,
    СУММА(ВЫБОР
        КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
            ТОГДА ВЫБОР
                КОГДА ЕСТЬNULL(КурсыВалют.Курс, 0) <> 0
                    ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалют.Курс, 0) КАК ЧИСЛО(16,2))
                ИНАЧЕ 0
            КОНЕЦ
        ИНАЧЕ ФактическиеДанные.Сумма
    КОНЕЦ) КАК СуммаВВалюте,
    СУММА(ВЫБОР
        КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
            ТОГДА ВЫБОР
                КОГДА ЕСТЬNULL(КурсыВалютПлан.Курс, 0) <> 0
                    ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалютПлан.Курс, 0) КАК ЧИСЛО(16,2))
                ИНАЧЕ 0
            КОНЕЦ
        ИНАЧЕ ФактическиеДанные.Сумма
    КОНЕЦ) КАК СуммаВВалютеПлановыйКурс,
    СУММА(ВЫБОР
        КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
            ТОГДА ВЫБОР
                КОГДА ЕСТЬNULL(КурсыВалютПланСледующийГод.Курс, 0) <> 0
                    ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалютПланСледующийГод.Курс, 0) КАК ЧИСЛО(16,2))
                ИНАЧЕ 0
            КОНЕЦ
        ИНАЧЕ ФактическиеДанные.Сумма
    КОНЕЦ) КАК СуммаВВалютеПлановыйКурсСледующийГод
ПОМЕСТИТЬ ВТ
ИЗ
    Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют
        ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалют.Валюта
        И ФактическиеДанные.Период = КурсыВалют.Период
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_КурсыВалютОтчетности КАК КурсыВалютПлан
        ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалютПлан.Валюта
        И НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ГОД) = КурсыВалютПлан.Период
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_КурсыВалютОтчетности КАК КурсыВалютПланСледующийГод
        ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалютПланСледующийГод.Валюта
        И ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ГОД), ГОД, 1) = КурсыВалютПланСледующийГод.Период
ГДЕ
    ФактическиеДанные.Ссылка.Проведен
    И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
    И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
    И ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[0-4][0-3]%"
СГРУППИРОВАТЬ ПО
    ФактическиеДанные.Период,
    ФактическиеДанные.ДоговорКонтрагента,
    ФактическиеДанные.Контрагент,
    ФактическиеДанные.НоменклатурнаяГруппа
