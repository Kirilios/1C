ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ) КАК Дата,
    КорректировкаТовары.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
    Реализация.Контрагент КАК Контрагент,
    Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,

    // --- аккумулируем по документам результаты подзапросов ---
    СУММА(КорректировкаТовары.Количество) КАК КоличествоТоваров,
    СУММА(КорректировкаТовары.КоличествоКорректировки) КАК КоличествоКорректировкиТоваров,
    СУММА(КорректировкаТовары.СуммаДоИзменения) КАК СуммаДоИзмененияТоваров,
    СУММА(КорректировкаТовары.Сумма) КАК СуммаПослеКорректировкиТоваров,
    СУММА(КорректировкаТовары.СуммаКорректировки) КАК СуммаКорректировкиТоваров,

    СУММА(КорректировкаУслуги.Количество) КАК КоличествоУслуг,
    СУММА(КорректировкаУслуги.КоличествоКорректировки) КАК КоличествоКорректировкиУслуг,
    СУММА(КорректировкаУслуги.СуммаДоИзменения) КАК СуммаДоИзмененияУслуг,
    СУММА(КорректировкаУслуги.Сумма) КАК СуммаУслуг,
    СУММА(КорректировкаУслуги.СуммаКорректировки) КАК СуммаКорректировкиУслуг

ИЗ
    Документ.КорректировкаРеализации КАК Корректировка

///////////////// Товары (агрегация по документу и по группе) /////////////////////
ЛЕВОЕ СОЕДИНЕНИЕ (
    ВЫБРАТЬ
        Товары.Ссылка КАК Ссылка,
        Товары.Субконто КАК НоменклатурнаяГруппа,
        СУММА(Товары.Количество) КАК Количество,
        СУММА(
            ВЫБОР
                КОГДА Товары.КоличествоДоИзменения - Товары.Количество < 0
                    ТОГДА Товары.Количество - Товары.КоличествоДоИзменения
                ИНАЧЕ Товары.КоличествоДоИзменения - Товары.Количество
            КОНЕЦ
        ) КАК КоличествоКорректировки,
        СУММА(Товары.СуммаДоИзменения) КАК СуммаДоИзменения,
        СУММА(Товары.Сумма) КАК Сумма,
        СУММА(
            ВЫБОР
                КОГДА Товары.СуммаДоИзменения - Товары.Сумма < 0
                    ТОГДА Товары.Сумма - Товары.СуммаДоИзменения
                ИНАЧЕ Товары.СуммаДоИзменения - Товары.Сумма
            КОНЕЦ
        ) КАК СуммаКорректировки
    ИЗ
        Документ.КорректировкаРеализации.Товары КАК Товары
    СГРУППИРОВАТЬ ПО
        Товары.Ссылка,
        Товары.Субконто
) КАК КорректировкаТовары
ПО Корректировка.Ссылка = КорректировкаТовары.Ссылка

///////////////// Услуги (агрегация по документу) /////////////////////
ЛЕВОЕ СОЕДИНЕНИЕ (
    ВЫБРАТЬ
        Услуги.Ссылка КАК Ссылка,
        СУММА(Услуги.Количество) КАК Количество,
        СУММА(
            ВЫБОР
                КОГДА Услуги.КоличествоДоИзменения - Услуги.Количество < 0
                    ТОГДА Услуги.Количество - Услуги.КоличествоДоИзменения
                ИНАЧЕ Услуги.КоличествоДоИзменения - Услуги.Количество
            КОНЕЦ
        ) КАК КоличествоКорректировки,
        СУММА(Услуги.СуммаДоИзменения) КАК СуммаДоИзменения,
        СУММА(Услуги.Сумма) КАК Сумма,
        СУММА(
            ВЫБОР
                КОГДА Услуги.СуммаДоИзменения - Услуги.Сумма < 0
                    ТОГДА Услуги.Сумма - Услуги.СуммаДоИзменения
                ИНАЧЕ Услуги.СуммаДоИзменения - Услуги.Сумма
            КОНЕЦ
        ) КАК СуммаКорректировки
    ИЗ
        Документ.КорректировкаРеализации.Услуги КАК Услуги
    СГРУППИРОВАТЬ ПО
        Услуги.Ссылка
) КАК КорректировкаУслуги
ПО Корректировка.Ссылка = КорректировкаУслуги.Ссылка

///////////////// Реализация /////////////////////
ЛЕВОЕ СОЕДИНЕНИЕ
    Документ.РеализацияТоваровУслуг КАК Реализация
ПО
    Корректировка.ДокументРеализации = Реализация.Ссылка

ГДЕ
    Корректировка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания

СГРУППИРОВАТЬ ПО
    НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ),
    КорректировкаТовары.НоменклатурнаяГруппа,
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента

УПОРЯДОЧИТЬ ПО
    Дата,
    НоменклатурнаяГруппа,
    Контрагент,
    ДоговорКонтрагента
