// --- Подзапрос Реализации ---
ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
    Реализация.Контрагент КАК Контрагент,
    Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
    ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто) КАК НоменклатурнаяГруппа,
    СУММА(ВЫБОР
            КОГДА ЕСТЬNULL(РТУТовары.Сумма,0) > 0
                ТОГДА ЕСТЬNULL(РТУТовары.Количество,0)
            ИНАЧЕ 0
        КОНЕЦ + ЕСТЬNULL(РТУУслуг.Количество,0)) КАК РеализацияКоличество,
    СУММА(ЕСТЬNULL(РТУТовары.Сумма,0) + ЕСТЬNULL(РТУУслуг.Сумма,0)) КАК РеализацияСумма
ИЗ
    Документ.РеализацияТоваровУслуг КАК Реализация
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
        ПО Реализация.Ссылка = РТУТовары.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
        ПО Реализация.Ссылка = РТУУслуг.Ссылка
ГДЕ
    Реализация.Проведен
    И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    И Реализация.Склад.Наименование ПОДОБНО "%Склад отгрузки готовой продукции%"
    И СОКРЛ(СОКРП(Реализация.ПодразделениеОрганизации.Код)) = "53"
СГРУППИРОВАТЬ ПО
    Реализация.Дата,
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента,
    ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто)
) КАК Реализация;

// --- Подзапрос Факта ---
ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Факт.Дата, ДЕНЬ) КАК Дата,
    Факт.Контрагент,
    Факт.ДоговорКонтрагента,
    Факт.НоменклатурнаяГруппа,
    СУММА(Факт.ФактКоличество) КАК ФактКоличество,
    СУММА(Факт.ФактСумма) КАК ФактСумма
ИЗ
    (ВЫБРАТЬ
         ФактическиеДанные.Период КАК Дата,
         ФактическиеДанные.Контрагент,
         ФактическиеДанные.ДоговорКонтрагента,
         ФактическиеДанные.НоменклатурнаяГруппа,
         ФактическиеДанные.Количество КАК ФактКоличество,
         ФактическиеДанные.Сумма КАК ФактСумма
     ИЗ
         Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
     ГДЕ
         ФактическиеДанные.Ссылка.Проведен
         И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
         И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
         И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
         И (
             ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.00[1-9]%" 
             ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[1-3][0-9]%" 
             ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.04[0-3]%"
         )
    ) КАК Факт
СГРУППИРОВАТЬ ПО
    Факт.Дата,
    Факт.Контрагент,
    Факт.ДоговорКонтрагента,
    Факт.НоменклатурнаяГруппа;

// --- Подзапрос Корректировки ---
ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Корр.Дата, ДЕНЬ) КАК Дата,
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента,
    ЕСТЬNULL(КоррТовары.Субконто,0) КАК НоменклатурнаяГруппа,
    СУММА(ВЫБОР
            КОГДА КоррУслуги.Количество > 0 ТОГДА КоррУслуги.Количество
            ИНАЧЕ КоррТовары.Количество
        КОНЕЦ) КАК КорректировкаКоличество,
    СУММА(ВЫБОР
            КОГДА КоррУслуги.Сумма > 0 ТОГДА КоррУслуги.Сумма
            ИНАЧЕ КоррТовары.Сумма
        КОНЕЦ) КАК КорректировкаСумма
ИЗ
    Документ.КорректировкаРеализации КАК Корр
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            Ссылка,
            Субконто,
            СУММА(Количество) КАК Количество,
            СУММА(Сумма) КАК Сумма
        ИЗ Документ.КорректировкаРеализации.Товары
        СГРУППИРОВАТЬ ПО
            Ссылка,
            Субконто
    ) КАК КоррТовары
        ПО Корр.Ссылка = КоррТовары.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            Ссылка,
            СУММА(Количество) КАК Количество,
            СУММА(Сумма) КАК Сумма
        ИЗ Документ.КорректировкаРеализации.Услуги
        СГРУППИРОВАТЬ ПО Ссылка
    ) КАК КоррУслуги
        ПО Корр.Ссылка = КоррУслуги.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
        ПО Корр.ДокументРеализации = Реализация.Ссылка
ГДЕ
    Корр.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
СГРУППИРОВАТЬ ПО
    Корр.Дата,
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента,
    ЕСТЬNULL(КоррТовары.Субконто,0);

// --- Финальный запрос: объединение всех трех подзапросов ---
ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Р.Дата, ДЕНЬ) КАК Дата,
    Р.Контрагент,
    Р.ДоговорКонтрагента,
    Р.НоменклатурнаяГруппа,
    ЕСТЬNULL(Р.РеализацияКоличество,0) КАК РеализацияКоличество,
    ЕСТЬNULL(Р.РеализацияСумма,0) КАК РеализацияСумма,
    ЕСТЬNULL(F.ФактКоличество,0) КАК ФактКоличество,
    ЕСТЬNULL(F.ФактСумма,0) КАК ФактСумма,
    ЕСТЬNULL(C.КорректировкаКоличество,0) КАК КорректировкаКоличество,
    ЕСТЬNULL(C.КорректировкаСумма,0) КАК КорректировкаСумма
ИЗ
    (Тут_подзапрос_Реализации) КАК Р
    ЛЕВОЕ СОЕДИНЕНИЕ (Тут_подзапрос_Факта) КАК F
        ПО Р.Дата = F.Дата
        И Р.Контрагент = F.Контрагент
        И Р.ДоговорКонтрагента = F.ДоговорКонтрагента
        И Р.НоменклатурнаяГруппа = F.НоменклатурнаяГруппа
    ЛЕВОЕ СОЕДИНЕНИЕ (Тут_подзапрос_Корректировки) КАК C
        ПО Р.Дата = C.Дата
        И Р.Контрагент = C.Контрагент
        И Р.ДоговорКонтрагента = C.ДоговорКонтрагента
        И Р.НоменклатурнаяГруппа = C.НоменклатурнаяГруппа
УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента;
