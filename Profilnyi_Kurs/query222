ВЫБРАТЬ
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа,
    СУММА(РеализацияКоличество) КАК РеализацияКоличество,
    СУММА(РеализацияСумма) КАК РеализацияСумма,
    СУММА(ФактКоличество) КАК ФактКоличество,
    СУММА(ФактСумма) КАК ФактСумма,
    СУММА(КорректировкаКоличество) КАК КорректировкаКоличество,
    СУММА(КорректировкаСумма) КАК КорректировкаСумма
ИЗ
(
    // ------------------ Реализация + Факт ------------------
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
        Реализация.Контрагент КАК Контрагент,
        Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ВЫБОР КОГДА ЕСТЬNULL(РТУТовары.Субконто,0) <> 0 ТОГДА РТУТовары.Субконто ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто,0) КОНЕЦ КАК НоменклатурнаяГруппа,
        СУММА(
            ВЫБОР КОГДА ЕСТЬNULL(РТУТовары.Сумма,0) > 0 ТОГДА ЕСТЬNULL(РТУТовары.Количество,0) ИНАЧЕ 0 КОНЕЦ +
            ЕСТЬNULL(РТУУслуг.Количество,0)
        ) КАК РеализацияКоличество,
        СУММА(
            ЕСТЬNULL(РТУТовары.Сумма,0) + ЕСТЬNULL(РТУУслуг.Сумма,0)
        ) КАК РеализацияСумма,
        ЕСТЬNULL(Факт.ФактКоличество,0) КАК ФактКоличество,
        ЕСТЬNULL(Факт.ФактСумма,0) КАК ФактСумма,
        0 КАК КорректировкаКоличество,
        0 КАК КорректировкаСумма
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
            ПО Реализация.Ссылка = РТУТовары.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
            ПО Реализация.Ссылка = РТУУслуг.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ) КАК Дата,
                ФактическиеДанные.Контрагент,
                ФактическиеДанные.ДоговорКонтрагента,
                ФактическиеДанные.НоменклатурнаяГруппа,
                СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
                СУММА(ФактическиеДанные.Сумма) КАК ФактСумма
            ИЗ
                Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
            ГДЕ
                ФактическиеДанные.Ссылка.Проведен
                И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
                И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
                И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
            СГРУППИРОВАТЬ ПО
                НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ),
                ФактическиеДанные.Контрагент,
                ФактическиеДанные.ДоговорКонтрагента,
                ФактическиеДанные.НоменклатурнаяГруппа
        ) КАК Факт
            ПО НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) = Факт.Дата
            И Реализация.Контрагент = Факт.Контрагент
            И Реализация.ДоговорКонтрагента = Факт.ДоговорКонтрагента
            И ВЫБОР КОГДА ЕСТЬNULL(РТУТовары.Субконто,0) <> 0 ТОГДА РТУТовары.Субконто ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто,0) КОНЕЦ = Факт.НоменклатурнаяГруппа

    ОБЪЕДИНИТЬ ВСЕ

    // ------------------ Корректировка ------------------
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ) КАК Дата,
        Реализация.Контрагент КАК Контрагент,
        Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ВЫБОР КОГДА ЕСТЬNULL(КоррТовары.Субконто,0) <> 0 ТОГДА КоррТовары.Субконто ИНАЧЕ 0 КОНЕЦ КАК НоменклатурнаяГруппа,
        0 КАК РеализацияКоличество,
        0 КАК РеализацияСумма,
        0 КАК ФактКоличество,
        0 КАК ФактСумма,
        СУММА(
            ВЫБОР КОГДА КоррУслуги.Количество > 0 ТОГДА КоррУслуги.Количество ИНАЧЕ КоррТовары.Количество КОНЕЦ
        ) КАК КорректировкаКоличество,
        СУММА(
            ВЫБОР КОГДА КоррУслуги.Сумма > 0 ТОГДА КоррУслуги.Сумма ИНАЧЕ КоррТовары.Сумма КОНЕЦ
        ) КАК КорректировкаСумма
    ИЗ
        Документ.КорректировкаРеализации КАК Корректировка
        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                Товары.Ссылка КАК Ссылка,
                Товары.Субконто КАК Субконто,
                СУММА(Товары.Количество) КАК Количество,
                СУММА(Товары.Сумма) КАК Сумма
            ИЗ
                Документ.КорректировкаРеализации.Товары КАК Товары
            СГРУППИРОВАТЬ ПО
                Товары.Ссылка,
                Товары.Субконто
        ) КАК КоррТовары
            ПО Корректировка.Ссылка = КоррТовары.Ссылка

        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                Услуги.Ссылка КАК Ссылка,
                СУММА(Услуги.Количество) КАК Количество,
                СУММА(Услуги.Сумма) КАК Сумма
            ИЗ
                Документ.КорректировкаРеализации.Услуги КАК Услуги
            СГРУППИРОВАТЬ ПО
                Услуги.Ссылка
        ) КАК КоррУслуги
            ПО Корректировка.Ссылка = КоррУслуги.Ссылка

        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
            ПО Корректировка.ДокументРеализации = Реализация.Ссылка

) КАК Объединенный
СГРУППИРОВАТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа
УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа
