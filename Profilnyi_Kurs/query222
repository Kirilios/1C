ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
    Реализация.Контрагент КАК Контрагент,
    Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
    ВЫБОР
        КОГДА НЕ ЕСТЬNULL(РТУТовары.Субконто) ТОГДА РТУТовары.Субконто
        ИНАЧЕ РТУУслуг_Подзапрос.НоменклатурнаяГруппа
    КОНЕЦ КАК НоменклатурнаяГруппа,
    ЕСТЬNULL(Реализация.РеализацияКоличество,0) КАК РеализацияКоличество,
    ЕСТЬNULL(Реализация.РеализацияСумма,0) КАК РеализацияСумма,
    ЕСТЬNULL(Факт.ФактКоличество,0) КАК ФактКоличество,
    ЕСТЬNULL(Факт.ФактСумма,0) КАК ФактСумма,
    ЕСТЬNULL(Корректировка.КорректировкаКоличество,0) КАК КорректировкаКоличество,
    ЕСТЬNULL(Корректировка.КорректировкаСумма,0) КАК КорректировкаСумма

ИЗ
    -- Реализация с объединением Товары + Услуги
    (ВЫБРАТЬ
        Реализация.Дата КАК Дата,
        Реализация.Контрагент КАК Контрагент,
        Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
        СУММА(
            ВЫБОР
                КОГДА ЕСТЬNULL(РТУТовары.Сумма,0) > 0
                    ТОГДА ЕСТЬNULL(РТУТовары.Количество,0)
                ИНАЧЕ 0
            КОНЕЦ +
            ЕСТЬNULL(РТУУслуг_Подзапрос.Количество,0)
        ) КАК РеализацияКоличество,
        СУММА(
            ЕСТЬNULL(РТУТовары.Сумма,0) +
            ЕСТЬNULL(РТУУслуг_Подзапрос.Сумма,0)
        ) КАК РеализацияСумма
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
            ПО Реализация.Ссылка = РТУТовары.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                Ссылка,
                ЕСТЬNULL(Субконто,"") КАК НоменклатурнаяГруппа,
                Количество,
                Сумма
            ИЗ Документ.РеализацияТоваровУслуг.Услуги
        ) КАК РТУУслуг_Подзапрос
            ПО Реализация.Ссылка = РТУУслуг_Подзапрос.Ссылка
    ГДЕ
        Реализация.Проведен
        И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        И Реализация.Склад.Наименование ПОДОБНО "%Склад отгрузки готовой продукции%"
        И СОКРЛ(СОКРП(Реализация.ПодразделениеОрганизации.Код)) = "53"
    СГРУППИРОВАТЬ ПО
        Реализация.Дата,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        РТУТовары.Субконто,
        РТУУслуг_Подзапрос.НоменклатурнаяГруппа
    ) КАК Реализация

    -- Факт
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ) КАК Дата,
            ФактическиеДанные.Контрагент,
            ФактическиеДанные.ДоговорКонтрагента,
            ФактическиеДанные.НоменклатурнаяГруппа,
            СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
            СУММА(ФактическиеДанные.Сумма) КАК ФактСумма
        ИЗ
            Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
        ГДЕ
            ФактическиеДанные.Ссылка.Проведен
            И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
            И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
            И ФактическиеДанные.СтатьяОборотов.ТипСтатьи =
                ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
        СГРУППИРОВАТЬ ПО
            НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ),
            ФактическиеДанные.Контрагент,
            ФактическиеДанные.ДоговорКонтрагента,
            ФактическиеДанные.НоменклатурнаяГруппа
    ) КАК Факт
    ПО
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) = Факт.Дата
        И Реализация.Контрагент = Факт.Контрагент
        И Реализация.ДоговорКонтрагента = Факт.ДоговорКонтрагента
        И ВЫБОР
            КОГДА НЕ ЕСТЬNULL(РТУТовары.Субконто) ТОГДА РТУТовары.Субконто
            ИНАЧЕ РТУУслуг_Подзапрос.НоменклатурнаяГруппа
        КОНЕЦ = Факт.НоменклатурнаяГруппа

    -- Корректировка
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            Корректировка.Дата КАК Дата,
            Реализация_Корр.Контрагент,
            Реализация_Корр.ДоговорКонтрагента,
            ВЫБОР
                КОГДА НЕ ЕСТЬNULL(КоррТовары.Субконто) ТОГДА КоррТовары.Субконто
                ИНАЧЕ КоррУслуги_Подзапрос.НоменклатурнаяГруппа
            КОНЕЦ КАК НоменклатурнаяГруппа,
            СУММА(
                ВЫБОР
                    КОГДА КоррУслуги_Подзапрос.Количество > 0
                        ТОГДА КоррУслуги_Подзапрос.Количество
                    ИНАЧЕ КоррТовары.Количество
                КОНЕЦ
            ) КАК КорректировкаКоличество,
            СУММА(
                ВЫБОР
                    КОГДА КоррУслуги_Подзапрос.Сумма > 0
                        ТОГДА КоррУслуги_Подзапрос.Сумма
                    ИНАЧЕ КоррТовары.Сумма
                КОНЕЦ
            ) КАК КорректировкаСумма
        ИЗ
            Документ.КорректировкаРеализации КАК Корректировка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация_Корр
                ПО Корректировка.ДокументРеализации = Реализация_Корр.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.КорректировкаРеализации.Товары КАК КоррТовары
                ПО Корректировка.Ссылка = КоррТовары.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ (
                ВЫБРАТЬ
                    Ссылка,
                    ЕСТЬNULL(Субконто,"") КАК НоменклатурнаяГруппа,
                    Количество,
                    Сумма
                ИЗ Документ.КорректировкаРеализации.Услуги
            ) КАК КоррУслуги_Подзапрос
                ПО Корректировка.Ссылка = КоррУслуги_Подзапрос.Ссылка
        ГДЕ
            Корректировка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        СГРУППИРОВАТЬ ПО
            Корректировка.Дата,
            Реализация_Корр.Контрагент,
            Реализация_Корр.ДоговорКонтрагента,
            КоррТовары.Субконто,
            КоррУслуги_Подзапрос.НоменклатурнаяГруппа
    ) КАК Корректировка
    ПО
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) = Корректировка.Дата
        И Реализация.Контрагент = Корректировка.Контрагент
        И Реализация.ДоговорКонтрагента = Корректировка.ДоговорКонтрагента
        И ВЫБОР
            КОГДА НЕ ЕСТЬNULL(РТУТовары.Субконто) ТОГДА РТУТовары.Субконто
            ИНАЧЕ РТУУслуг_Подзапрос.НоменклатурнаяГруппа
        КОНЕЦ = Корректировка.НоменклатурнаяГруппа

УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента,
    НоменклатурнаяГруппа
