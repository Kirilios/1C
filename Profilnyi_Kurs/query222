// ========================
// 1. Реализация + Факт
// ========================
ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
    Реализация.Контрагент КАК Контрагент,
    Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
    ВЫБОР
        КОГДА ЕСТЬNULL(РТУТовары.Субконто,0) <> 0 ТОГДА РТУТовары.Субконто
        ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто,0)
    КОНЕЦ КАК НоменклатурнаяГруппа,
    СУММА(
        ВЫБОР
            КОГДА ЕСТЬNULL(РТУТовары.Сумма,0) > 0 ТОГДА ЕСТЬNULL(РТУТовары.Количество,0)
            ИНАЧЕ 0
        КОНЕЦ +
        ЕСТЬNULL(РТУУслуг.Количество,0)
    ) КАК РеализацияКоличество,
    СУММА(
        ЕСТЬNULL(РТУТовары.Сумма,0) + ЕСТЬNULL(РТУУслуг.Сумма,0)
    ) КАК РеализацияСумма,
    СУММА(ЕСТЬNULL(Факт.ФактКоличество,0)) КАК ФактКоличество,
    СУММА(ЕСТЬNULL(Факт.ФактСумма,0)) КАК ФактСумма
ИЗ
    Документ.РеализацияТоваровУслуг КАК Реализация
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
        ПО Реализация.Ссылка = РТУТовары.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
        ПО Реализация.Ссылка = РТУУслуг.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ) КАК Дата,
            ФактическиеДанные.Контрагент,
            ФактическиеДанные.ДоговорКонтрагента,
            ФактическиеДанные.НоменклатурнаяГруппа,
            СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
            СУММА(ФактическиеДанные.Сумма) КАК ФактСумма
        ИЗ
            Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
        ГДЕ
            ФактическиеДанные.Ссылка.Проведен
            И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
            И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
        СГРУППИРОВАТЬ ПО
            НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ),
            ФактическиеДанные.Контрагент,
            ФактическиеДанные.ДоговорКонтрагента,
            ФактическиеДанные.НоменклатурнаяГруппа
    ) КАК Факт
        ПО
            НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) = Факт.Дата
            И Реализация.Контрагент = Факт.Контрагент
            И Реализация.ДоговорКонтрагента = Факт.ДоговорКонтрагента
            И ВЫБОР
                КОГДА ЕСТЬNULL(РТУТовары.Субконто,0) <> 0 ТОГДА РТУТовары.Субконто
                ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто,0)
            КОНЕЦ = Факт.НоменклатурнаяГруппа
СГРУППИРОВАТЬ ПО
    НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ),
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента,
    ВЫБОР
        КОГДА ЕСТЬNULL(РТУТовары.Субконто,0) <> 0 ТОГДА РТУТовары.Субконто
        ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто,0)
    КОНЕЦ

// ========================
// 2. Корректировка
// ========================
ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
    НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ) КАК Дата,
    Реализация.Контрагент КАК Контрагент,
    Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
    ВЫБОР
        КОГДА ЕСТЬNULL(КоррТовары.Субконто,0) <> 0 ТОГДА КоррТовары.Субконто
        ИНАЧЕ 0
    КОНЕЦ КАК НоменклатурнаяГруппа,
    СУММА(
        ВЫБОР
            КОГДА ЕСТЬNULL(КоррУслуги.Количество,0) > 0 ТОГДА КоррУслуги.Количество
            ИНАЧЕ КоррТовары.Количество
        КОНЕЦ
    ) КАК КорректировкаКоличество,
    СУММА(
        ВЫБОР
            КОГДА ЕСТЬNULL(КоррУслуги.Сумма,0) > 0 ТОГДА КоррУслуги.Сумма
            ИНАЧЕ КоррТовары.Сумма
        КОНЕЦ
    ) КАК КорректировкаСумма
ИЗ
    Документ.КорректировкаРеализации КАК Корректировка
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            Ссылка,
            Субконто,
            СУММА(Количество) КАК Количество,
            СУММА(Сумма) КАК Сумма
        ИЗ Документ.КорректировкаРеализации.Товары
        СГРУППИРОВАТЬ ПО Ссылка, Субконто
    ) КАК КоррТовары
        ПО Корректировка.Ссылка = КоррТовары.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ (
        ВЫБРАТЬ
            Ссылка,
            СУММА(Количество) КАК Количество,
            СУММА(Сумма) КАК Сумма
        ИЗ Документ.КорректировкаРеализации.Услуги
        СГРУППИРОВАТЬ ПО Ссылка
    ) КАК КоррУслуги
        ПО Корректировка.Ссылка = КоррУслуги.Ссылка
    ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
        ПО Корректировка.ДокументРеализации = Реализация.Ссылка
ГДЕ
    Корректировка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
СГРУППИРОВАТЬ ПО
    НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ),
    Реализация.Контрагент,
    Реализация.ДоговорКонтрагента,
    ВЫБОР
        КОГДА ЕСТЬNULL(КоррТовары.Субконто,0) <> 0 ТОГДА КоррТовары.Субконто
        ИНАЧЕ 0
    КОНЕЦ

УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента
