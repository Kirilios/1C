ВЫБРАТЬ РАЗРЕШЕННЫЕ
	ФактическиеДанные.Ссылка.Сценарий КАК Сценарий,
	ВЫБОР
		КОГДА ФактическиеДанные.Ссылка.Сценарий = &ВерсияПлана
			ТОГДА ФактическиеДанные.Период
		КОГДА ФактическиеДанные.Ссылка.Сценарий.Наименование = "13 Период"
			ТОГДА ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД), ГОД, 1)
		КОГДА ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
			ТОГДА ВЫБОР
					КОГДА ГОД(ФактическиеДанные.Период) < ГОД(&ДатаОтчета)
						ТОГДА ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД), ДЕНЬ, -1)
					ИНАЧЕ НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, МЕСЯЦ)
				КОНЕЦ
	КОНЕЦ КАК Период,
	ВЫБОР
		КОГДА ФактическиеДанные.Регистратор ССЫЛКА Документ.КорректировкаРеализации
				И (ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.00[69] %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.01[47] %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.020.2 %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.027 %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.030 %")
			ТОГДА ИСТИНА
		ИНАЧЕ ЛОЖЬ
	КОНЕЦ КАК ЭтоКорректировкаВыручки,
	ФактическиеДанные.СтатьяОборотов КАК СтатьяОборотов,
	ФактическиеДанные.Контрагент КАК Контрагент,
	ФактическиеДанные.ДоговорКонтрагента КАК ДоговорКонтрагента,
	ФактическиеДанные.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	СУММА(ФактическиеДанные.Количество) КАК Количество,
	СУММА(ФактическиеДанные.Сумма) КАК Сумма,
	СУММА(ВЫБОР
			КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
				ТОГДА ВЫБОР
						КОГДА ЕСТЬNULL(КурсыВалют.Курс, 0) <> 0
							ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалют.Курс, 0) КАК ЧИСЛО(16, 2))
						ИНАЧЕ 0
					КОНЕЦ
			ИНАЧЕ ФактическиеДанные.Сумма
		КОНЕЦ) КАК СуммаВВалюте,
	СУММА(ВЫБОР
			КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
				ТОГДА ВЫБОР
						КОГДА ЕСТЬNULL(КурсыВалютПлан.Курс, 0) <> 0
							ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалютПлан.Курс, 0) КАК ЧИСЛО(16, 2))
						ИНАЧЕ 0
					КОНЕЦ
			ИНАЧЕ ФактическиеДанные.Сумма
		КОНЕЦ) КАК СуммаВВалютеПлановыйКурс,
	СУММА(ВЫБОР
			КОГДА ФактическиеДанные.ДоговорКонтрагента.Валютный
				ТОГДА ВЫБОР
						КОГДА ЕСТЬNULL(КурсыВалютПланСледующийГод.Курс, 0) <> 0
							ТОГДА ВЫРАЗИТЬ(ФактическиеДанные.Сумма / ЕСТЬNULL(КурсыВалютПланСледующийГод.Курс, 0) КАК ЧИСЛО(16, 2))
						ИНАЧЕ 0
					КОНЕЦ
			ИНАЧЕ ФактическиеДанные.Сумма
		КОНЕЦ) КАК СуммаВВалютеПлановыйКурсСледующийГод
ПОМЕСТИТЬ ВТ
ИЗ
	Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.КурсыВалют КАК КурсыВалют
		ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалют.Валюта
			И ФактическиеДанные.Период = КурсыВалют.Период
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_КурсыВалютОтчетности КАК КурсыВалютПлан
		ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалютПлан.Валюта
			И (НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ГОД) = КурсыВалютПлан.Период)
		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.бит_КурсыВалютОтчетности КАК КурсыВалютПланСледующийГод
		ПО ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов = КурсыВалютПланСледующийГод.Валюта
			И (ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ГОД), ГОД, 1) = КурсыВалютПланСледующийГод.Период)
ГДЕ
	ФактическиеДанные.Ссылка.Проведен
	И (ФактическиеДанные.Ссылка.Сценарий.Наименование В ("13 Период", "ФАКТ")
			ИЛИ ФактическиеДанные.Ссылка.Сценарий = &ВерсияПлана)
	И ВЫБОР
			КОГДА ФактическиеДанные.Ссылка.Сценарий.Наименование = "13 Период"
					ИЛИ ФактическиеДанные.Ссылка.Сценарий = &ВерсияПлана
				ТОГДА ГОД(ФактическиеДанные.Период) = ГОД(&ДатаОтчета)
			ИНАЧЕ ГОД(ФактическиеДанные.Период) <= ГОД(&ДатаОтчета)
		КОНЕЦ
	И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
	И (ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.00[1-9]%"
			ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[1-3][0-9]%"
			ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.04[0-3]%")

СГРУППИРОВАТЬ ПО
	ФактическиеДанные.Ссылка.Сценарий,
	ВЫБОР
		КОГДА ФактическиеДанные.Ссылка.Сценарий = &ВерсияПлана
			ТОГДА ФактическиеДанные.Период
		КОГДА ФактическиеДанные.Ссылка.Сценарий.Наименование = "13 Период"
			ТОГДА ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД), ГОД, 1)
		КОГДА ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
			ТОГДА ВЫБОР
					КОГДА ГОД(ФактическиеДанные.Период) < ГОД(&ДатаОтчета)
						ТОГДА ДОБАВИТЬКДАТЕ(НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД), ДЕНЬ, -1)
					ИНАЧЕ НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, МЕСЯЦ)
				КОНЕЦ
	КОНЕЦ,
	ВЫБОР
		КОГДА ФактическиеДанные.Регистратор ССЫЛКА Документ.КорректировкаРеализации
				И (ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.00[69] %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.01[47] %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.020.2 %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.027 %"
					ИЛИ ФактическиеДанные.ИсточникДанных.Наименование ПОДОБНО "11.42.030 %")
			ТОГДА ИСТИНА
		ИНАЧЕ ЛОЖЬ
	КОНЕЦ,
	ФактическиеДанные.СтатьяОборотов,
	ФактическиеДанные.Контрагент,
	ФактическиеДанные.ДоговорКонтрагента,
	ФактическиеДанные.НоменклатурнаяГруппа,
	ФактическиеДанные.ДоговорКонтрагента.ВалютаВзаиморасчетов
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗЛИЧНЫЕ
	ВТ.ДоговорКонтрагента КАК ДоговорКонтрагента
ПОМЕСТИТЬ ВТ_ОтборДляФакта
ИЗ
	ВТ КАК ВТ
ГДЕ
	ВТ.Сценарий = &ВерсияПлана
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ.Сценарий КАК Сценарий,
	ВТ.Период КАК Период,
	ВТ.ЭтоКорректировкаВыручки КАК ЭтоКорректировкаВыручки,
	ВТ.ДоговорКонтрагента КАК ДоговорКонтрагента,
	ВТ.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	ВЫБОР
		КОГДА ВТ.Сценарий.Наименование = "ФАКТ"
			ТОГДА "Фактический год"
		КОГДА ВТ.Сценарий = &ВерсияПлана
			ТОГДА "Плановый год"
		ИНАЧЕ ""
	КОНЕЦ КАК ТипРасчета,
	ВТ.Количество КАК Количество,
	ВТ.Сумма КАК Сумма,
	ВТ.СуммаВВалюте КАК СуммаВВалюте,
	ВТ.СуммаВВалютеПлановыйКурс КАК СуммаВВалютеПлановыйКурс,
	ВТ.СуммаВВалютеПлановыйКурсСледующийГод КАК СуммаВВалютеПлановыйКурсСледующийГод
ПОМЕСТИТЬ ВТ_Итог
ИЗ
	ВТ КАК ВТ
ГДЕ
	(ВТ.Сценарий.Наименование В ("13 Период")
			ИЛИ ВТ.Сценарий = &ВерсияПлана
			ИЛИ ВТ.Сценарий.Наименование = "ФАКТ"
				И ГОД(ВТ.Период) = ГОД(&ДатаОтчета))

ОБЪЕДИНИТЬ

ВЫБРАТЬ
	ВТ.Сценарий,
	ВТ.Период,
	ВТ.ЭтоКорректировкаВыручки,
	ВТ.ДоговорКонтрагента,
	ВТ.НоменклатурнаяГруппа,
	"",
	ВТ.Количество,
	ВТ.Сумма,
	ВТ.СуммаВВалюте,
	ВТ.СуммаВВалютеПлановыйКурс,
	ВТ.СуммаВВалютеПлановыйКурсСледующийГод
ИЗ
	ВТ КАК ВТ
ГДЕ
	ВТ.Сценарий.Наименование = "ФАКТ"
	И ГОД(ВТ.Период) < ГОД(&ДатаОтчета)
	И ВТ.ДоговорКонтрагента В
			(ВЫБРАТЬ
				ВТ_ОтборДляФакта.ДоговорКонтрагента
			ИЗ
				ВТ_ОтборДляФакта)
	И ВТ.ДоговорКонтрагента <> ЗНАЧЕНИЕ(Справочник.ДоговорыКонтрагентов.ПустаяСсылка)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Итог.Сценарий КАК Сценарий,
	ВТ_Итог.Сценарий.Наименование КАК СценарийНаименование,
	ВТ_Итог.Период КАК Период,
	ВТ_Итог.ЭтоКорректировкаВыручки КАК ЭтоКорректировкаВыручки,
	ВТ_Итог.ДоговорКонтрагента КАК ДоговорКонтрагента,
	ВТ_Итог.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	ВТ_Итог.ТипРасчета КАК ТипРасчета,
	ВТ_Итог.Количество КАК Количество,
	ВТ_Итог.Сумма КАК Сумма,
	ВТ_Итог.СуммаВВалюте КАК СуммаВВалюте,
	ВЫБОР
		КОГДА ВТ_Итог.Сценарий.Наименование = "13 Период"
			ТОГДА ВЫБОР
					КОГДА ВТ_Итог.СуммаВВалютеПлановыйКурсСледующийГод <> 0
						ТОГДА ВТ_Итог.СуммаВВалютеПлановыйКурсСледующийГод
					ИНАЧЕ ВТ_Итог.СуммаВВалютеПлановыйКурс
				КОНЕЦ
		ИНАЧЕ ВТ_Итог.СуммаВВалютеПлановыйКурс
	КОНЕЦ КАК СуммаВВалютеПлановыйКурс
ПОМЕСТИТЬ ВТ_Итоги
ИЗ
	ВТ_Итог КАК ВТ_Итог
ГДЕ
	ВЫБОР
			КОГДА ВТ_Итог.ТипРасчета <> ""
				ТОГДА ВЫБОР
						КОГДА МЕСЯЦ(ВТ_Итог.Период) <= &МесяцФакта
							ТОГДА ВТ_Итог.ТипРасчета = "Фактический год"
									ИЛИ ВТ_Итог.ТипРасчета = "Плановый год"
						ИНАЧЕ ВТ_Итог.ТипРасчета = "Плановый год"
					КОНЕЦ
			ИНАЧЕ ИСТИНА
		КОНЕЦ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Итоги.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	ВТ_Итоги.ДоговорКонтрагента КАК ДоговорКонтрагента,
	СУММА(ВТ_Итоги.Количество) КАК Количество
ПОМЕСТИТЬ ВТ_Номенклатура
ИЗ
	ВТ_Итоги КАК ВТ_Итоги
ГДЕ
	ВЫБОР
			КОГДА ВТ_Итоги.ТипРасчета <> ""
				ТОГДА ВЫБОР
						КОГДА МЕСЯЦ(ВТ_Итоги.Период) <= &МесяцФакта
							ТОГДА ВТ_Итоги.ТипРасчета = "Фактический год"
						ИНАЧЕ ВТ_Итоги.ТипРасчета = "Плановый год"
					КОНЕЦ
			ИНАЧЕ ИСТИНА
		КОНЕЦ

СГРУППИРОВАТЬ ПО
	ВТ_Итоги.НоменклатурнаяГруппа,
	ВТ_Итоги.ДоговорКонтрагента
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.ПустаяСсылка) КАК Сценарий,
	"Общий результат" КАК СценарийНаименование,
	НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД) КАК Период,
	ВТ_Итоги.ЭтоКорректировкаВыручки КАК ЭтоКорректировкаВыручки,
	ВТ_Итоги.ДоговорКонтрагента КАК ДоговорКонтрагента,
	ВТ_Итоги.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	ВТ_Итоги.НоменклатурнаяГруппа.Наименование КАК НоменклатурнаяГруппаНаименование,
	"" КАК ТипРасчета,
	ВТ_Итоги.Количество КАК Количество,
	ВТ_Итоги.Сумма КАК Сумма,
	ВТ_Итоги.СуммаВВалюте КАК СуммаВВалюте,
	ВТ_Итоги.СуммаВВалютеПлановыйКурс КАК СуммаВВалютеПлановыйКурс,
	0 КАК КоличествоВЗаказе
ПОМЕСТИТЬ ВТТ
ИЗ
	ВТ_Итоги КАК ВТ_Итоги
ГДЕ
	ВЫБОР
			КОГДА ВТ_Итоги.ТипРасчета <> ""
				ТОГДА ВЫБОР
						КОГДА МЕСЯЦ(ВТ_Итоги.Период) <= &МесяцФакта
							ТОГДА ВТ_Итоги.ТипРасчета = "Фактический год"
						ИНАЧЕ ВТ_Итоги.ТипРасчета = "Плановый год"
					КОНЕЦ
			ИНАЧЕ ИСТИНА
		КОНЕЦ

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ЗНАЧЕНИЕ(Справочник.СценарииПланирования.ПустаяСсылка),
	"Итого за год",
	НАЧАЛОПЕРИОДА(&ДатаОтчета, ГОД),
	ВТ_Итоги.ЭтоКорректировкаВыручки,
	ВТ_Итоги.ДоговорКонтрагента,
	ВТ_Итоги.НоменклатурнаяГруппа,
	ВТ_Итоги.НоменклатурнаяГруппа.Наименование,
	ВТ_Итоги.ТипРасчета,
	ВТ_Итоги.Количество,
	ВТ_Итоги.Сумма,
	ВТ_Итоги.СуммаВВалюте,
	ВТ_Итоги.СуммаВВалютеПлановыйКурс,
	0
ИЗ
	ВТ_Итоги КАК ВТ_Итоги
ГДЕ
	ГОД(ВТ_Итоги.Период) = ГОД(&ДатаОтчета)
	И ВЫБОР
			КОГДА ВТ_Итоги.ТипРасчета <> ""
				ТОГДА ВЫБОР
						КОГДА МЕСЯЦ(ВТ_Итоги.Период) <= &МесяцФакта
							ТОГДА ВТ_Итоги.ТипРасчета = "Фактический год"
						ИНАЧЕ ВТ_Итоги.ТипРасчета = "Плановый год"
					КОНЕЦ
			ИНАЧЕ ИСТИНА
		КОНЕЦ

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_Итоги.Сценарий,
	ВТ_Итоги.СценарийНаименование,
	ВТ_Итоги.Период,
	ВТ_Итоги.ЭтоКорректировкаВыручки,
	ВТ_Итоги.ДоговорКонтрагента,
	ВТ_Итоги.НоменклатурнаяГруппа,
	ВТ_Итоги.НоменклатурнаяГруппа.Наименование,
	ВТ_Итоги.ТипРасчета,
	ВТ_Итоги.Количество,
	ВТ_Итоги.Сумма,
	ВТ_Итоги.СуммаВВалюте,
	ВТ_Итоги.СуммаВВалютеПлановыйКурс,
	ЕСТЬNULL(ВТ_Номенклатура.Количество, 0)
ИЗ
	ВТ_Итоги КАК ВТ_Итоги
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_Номенклатура КАК ВТ_Номенклатура
		ПО ВТ_Итоги.НоменклатурнаяГруппа = ВТ_Номенклатура.НоменклатурнаяГруппа
			И ВТ_Итоги.ДоговорКонтрагента = ВТ_Номенклатура.ДоговорКонтрагента
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТТ.Сценарий КАК Сценарий,
	ВТТ.СценарийНаименование КАК СценарийНаименование,
	ВТТ.Период КАК Период,
	ВТТ.ЭтоКорректировкаВыручки КАК ЭтоКорректировкаВыручки,
	ВТТ.ДоговорКонтрагента КАК ДоговорКонтрагента,
	ВТТ.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
	ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ КАК ЕНГП,
	ВЫБОР
		КОГДА ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ = "9999"
			ТОГДА "9999&Прочие работы и услуги"
		КОГДА ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ <> ""
				И (ВЫРАЗИТЬ(ПОДСТРОКА(ВТТ.НоменклатурнаяГруппаНаименование, СТРНАЙТИ(ВТТ.НоменклатурнаяГруппаНаименование, "&") + 1, ДЛИНАСТРОКИ(ВТТ.НоменклатурнаяГруппаНаименование)) КАК СТРОКА(100))) <> ""
			ТОГДА ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ + ": " + (ВЫРАЗИТЬ(ПОДСТРОКА(ВТТ.НоменклатурнаяГруппаНаименование, СТРНАЙТИ(ВТТ.НоменклатурнаяГруппаНаименование, "&") + 1, ДЛИНАСТРОКИ(ВТТ.НоменклатурнаяГруппаНаименование)) КАК СТРОКА(100)))
		ИНАЧЕ ""
	КОНЕЦ КАК ЕНГПНаименование,
	ВТТ.НоменклатурнаяГруппаНаименование КАК НоменклатурнаяГруппаНаименование,
	ВЫРАЗИТЬ(ВЫБОР
			КОГДА ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ = "90"
				ТОГДА ВЫБОР
						КОГДА СТРНАЙТИ(ВТТ.НоменклатурнаяГруппа.Наименование, "#") <> 0
							ТОГДА ПОДСТРОКА(ВТТ.НоменклатурнаяГруппа.Наименование, СТРНАЙТИ(ВТТ.НоменклатурнаяГруппа.Наименование, "&"), СТРНАЙТИ(ВТТ.НоменклатурнаяГруппа.Наименование, "&") + 5)
						ИНАЧЕ "<Неопределено>"
					КОНЕЦ
			ИНАЧЕ ВЫБОР
					КОГДА ВТТ.НоменклатурнаяГруппа.ga_КодЕНГПВСФЭУ = "9999"
						ТОГДА "У0001"
					ИНАЧЕ ВЫБОР
							КОГДА ВТТ.НоменклатурнаяГруппа.Наименование ПОДОБНО "%#%"
									И (ВТТ.НоменклатурнаяГруппа.Наименование ПОДОБНО "21%"
										ИЛИ ВТТ.НоменклатурнаяГруппа.Наименование ПОДОБНО "20%"
										ИЛИ ВТТ.НоменклатурнаяГруппа.Наименование ПОДОБНО "#%")
								ТОГДА ПОДСТРОКА(ВТТ.НоменклатурнаяГруппа.Наименование, СТРНАЙТИ(ВТТ.НоменклатурнаяГруппа.Наименование, "#") + 1, 5)
							ИНАЧЕ ВЫБОР
									КОГДА ВТТ.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование <> ""
										ТОГДА ВТТ.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование
									ИНАЧЕ "<Неопределено>"
								КОНЕЦ
						КОНЕЦ
				КОНЕЦ
		КОНЕЦ КАК СТРОКА(100)) КАК Заказы,
	ВТТ.ТипРасчета КАК ТипРасчета,
	ВЫБОР
		КОГДА ВТТ.ТипРасчета = "ОбщийРезультат"
			ТОГДА "Общий результат"
		ИНАЧЕ ""
	КОНЕЦ КАК Пустое,
	ВТТ.Сумма КАК Сумма,
	ВТТ.Количество КАК Количество,
	ВЫБОР
		КОГДА ВТТ.ЭтоКорректировкаВыручки
			ТОГДА 0
		ИНАЧЕ ВТТ.Сумма
	КОНЕЦ КАК СуммаВыручка,
	ВЫБОР
		КОГДА ВТТ.ЭтоКорректировкаВыручки
			ТОГДА ВТТ.Сумма
		ИНАЧЕ 0
	КОНЕЦ КАК КорректировкаВыручки,
	ВТТ.СуммаВВалюте КАК СуммаВВалюте,
	ВТТ.СуммаВВалютеПлановыйКурс КАК СуммаВВалютеПлановыйКурс,
	ВЫБОР
		КОГДА ВТТ.СуммаВВалюте <> 0
			ТОГДА ВТТ.СуммаВВалюте
		ИНАЧЕ ВТТ.СуммаВВалютеПлановыйКурс
	КОНЕЦ КАК СуммаВВалютеОбщая,
	ВТТ.КоличествоВЗаказе КАК КоличествоВЗаказе,
	ВЫБОР
		КОГДА ВТТ.Количество <> 0
			ТОГДА ВТТ.Сумма / ВТТ.Количество
		ИНАЧЕ 0
	КОНЕЦ КАК Цена,
	ВЫБОР
		КОГДА ВТТ.Количество <> 0
			ТОГДА ВТТ.СуммаВВалюте / ВТТ.Количество
		ИНАЧЕ 0
	КОНЕЦ КАК ЦенаВВалюте
ПОМЕСТИТЬ ВТ2
ИЗ
	ВТТ КАК ВТТ
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ2.Сценарий КАК Сценарий,
	ВТ2.СценарийНаименование КАК СценарийНаименование,
	НАЧАЛОПЕРИОДА(ВТ2.Период, МЕСЯЦ) КАК Период,
	ВТ2.ЕНГП КАК ЕНГП,
	ВТ2.ЕНГПНаименование КАК ЕНГПНаименование,
	ВТ2.Заказы КАК Заказы,
	ВТ2.Пустое КАК Пустое,
	ВЫБОР
		КОГДА ВТ2.Заказы = "У0001"
				И ВТ2.ЕНГП = "9999"
			ТОГДА 1
		ИНАЧЕ СУММА(ВТ2.Количество)
	КОНЕЦ КАК Количество,
	СУММА(ВТ2.КоличествоВЗаказе) КАК КоличествоВЗаказе,
	СУММА(ВТ2.КорректировкаВыручки) КАК КорректировкаВыручки,
	СУММА(ВТ2.СуммаВыручка) КАК СуммаВыручка,
	СУММА(ВТ2.Сумма) КАК Сумма,
	СУММА(ВТ2.СуммаВВалюте) КАК СуммаВВалюте,
	СУММА(ВТ2.СуммаВВалютеПлановыйКурс) КАК СуммаВВалютеПлановыйКурс,
	СУММА(ВТ2.СуммаВВалютеОбщая) КАК СуммаВВалютеОбщая
ПОМЕСТИТЬ ВТ3
ИЗ
	ВТ2 КАК ВТ2

СГРУППИРОВАТЬ ПО
	ВТ2.Сценарий,
	ВТ2.СценарийНаименование,
	НАЧАЛОПЕРИОДА(ВТ2.Период, МЕСЯЦ),
	ВТ2.ЕНГП,
	ВТ2.ЕНГПНаименование,
	ВТ2.Заказы,
	ВТ2.Пустое
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ3.Сценарий КАК Сценарий,
	ВТ3.СценарийНаименование КАК СценарийНаименование,
	ВТ3.Период КАК Период,
	ВТ3.ЕНГП КАК ЕНГП,
	ВТ3.ЕНГПНаименование КАК ЕНГПНаименование,
	ВТ3.Заказы КАК Заказы,
	ВТ3.Пустое КАК Пустое,
	ВТ3.Количество КАК Количество,
	ВТ3.КоличествоВЗаказе КАК КоличествоВЗаказе,
	ВТ3.КорректировкаВыручки КАК КорректировкаВыручки,
	ВТ3.Сумма КАК Сумма,
	ВТ3.СуммаВыручка КАК СуммаВыручка,
	ВТ3.СуммаВВалюте КАК СуммаВВалюте,
	ВТ3.СуммаВВалютеПлановыйКурс КАК СуммаВВалютеПлановыйКурс,
	ВТ3.СуммаВВалютеОбщая КАК СуммаВВалютеОбщая,
	ВЫБОР
		КОГДА ВТ3.Количество <> 0
			ТОГДА ВТ3.Сумма / ВТ3.Количество
		ИНАЧЕ 0
	КОНЕЦ КАК Цена,
	ВЫБОР
		КОГДА ВТ3.Количество <> 0
			ТОГДА ВТ3.СуммаВВалюте / ВТ3.Количество
		ИНАЧЕ 0
	КОНЕЦ КАК ЦенаВВалюте
ИЗ
	ВТ3 КАК ВТ3