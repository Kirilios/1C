ВЫБРАТЬ
    Данные.Дата,
    Данные.Контрагент,
    Данные.ДоговорКонтрагента,
    Данные.НоменклатурнаяГруппа,
    СУММА(Данные.РеализацияКоличество) КАК РеализацияКоличество,
    СУММА(Данные.РеализацияСумма) КАК РеализацияСумма,
    СУММА(Данные.ФактКоличество) КАК ФактКоличество,
    СУММА(Данные.ФактСумма) КАК ФактСумма,
    СУММА(Данные.КорректировкаКоличество) КАК КорректировкаКоличество,
    СУММА(Данные.КорректировкаСумма) КАК КорректировкаСумма
ИЗ
    (ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ) КАК Дата,
        Реализация.Контрагент КАК Контрагент,
        Реализация.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ВЫБОР
            КОГДА ЕСТЬNULL(РТУТовары.Субконто, ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)
                ТОГДА РТУТовары.Субконто
            ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто, ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка))
        КОНЕЦ КАК НоменклатурнаяГруппа,
        СУММА(ЕСТЬNULL(РТУТовары.Количество, 0) + ЕСТЬNULL(РТУУслуг.Количество, 0)) КАК РеализацияКоличество,
        СУММА(ЕСТЬNULL(РТУТовары.Сумма, 0) + ЕСТЬNULL(РТУУслуг.Сумма, 0)) КАК РеализацияСумма,
        0 КАК ФактКоличество,
        0 КАК ФактСумма,
        0 КАК КорректировкаКоличество,
        0 КАК КорректировкаСумма
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
            ПО Реализация.Ссылка = РТУТовары.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
            ПО Реализация.Ссылка = РТУУслуг.Ссылка
    ГДЕ
        Реализация.Проведен
        И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        И Реализация.Склад.Наименование ПОДОБНО "%Склад отгрузки готовой продукции%"
        И СОКРЛ(СОКРП(Реализация.ПодразделениеОрганизации.Код)) = "53"
    СГРУППИРОВАТЬ ПО
        НАЧАЛОПЕРИОДА(Реализация.Дата, ДЕНЬ),
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        ВЫБОР
            КОГДА ЕСТЬNULL(РТУТовары.Субконто, ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка)
                ТОГДА РТУТовары.Субконто
            ИНАЧЕ ЕСТЬNULL(РТУУслуг.Субконто, ЗНАЧЕНИЕ(Справочник.НоменклатурныеГруппы.ПустаяСсылка))
        КОНЕЦ
    
    ОБЪЕДИНИТЬ ВСЕ
    
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ) КАК Дата,
        ФактическиеДанные.Контрагент КАК Контрагент,
        ФактическиеДанные.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ФактическиеДанные.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
        0 КАК РеализацияКоличество,
        0 КАК РеализацияСумма,
        СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
        СУММА(ФактическиеДанные.Сумма) КАК ФактСумма,
        0 КАК КорректировкаКоличество,
        0 КАК КорректировкаСумма
    ИЗ
        Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
    ГДЕ
        ФактическиеДанные.Ссылка.Проведен
        И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
        И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
        И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
        И (ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.00[1-9]%"
            ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[1-3][0-9]%"
            ИЛИ ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.04[0-3]%")
    СГРУППИРОВАТЬ ПО
        НАЧАЛОПЕРИОДА(ФактическиеДанные.Период, ДЕНЬ),
        ФактическиеДанные.Контрагент,
        ФактическиеДанные.ДоговорКонтрагента,
        ФактическиеДанные.НоменклатурнаяГруппа
        
    ОБЪЕДИНИТЬ ВСЕ
    
    ВЫБРАТЬ
        НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ) КАК Дата,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        КорректировкаТовары.НоменклатурнаяГруппа,
        0 КАК РеализацияКоличество,
        0 КАК РеализацияСумма,
        0 КАК ФактКоличество,
        0 КАК ФактСумма,
        СУММА(ЕСТЬNULL(КорректировкаТовары.КоличествоКорректировки, 0) + ЕСТЬNULL(КорректировкаУслуги.КоличествоКорректировки, 0)) КАК КорректировкаКоличество,
        СУММА(ЕСТЬNULL(КорректировкаТовары.СуммаКорректировки, 0) + ЕСТЬNULL(КорректировкаУслуги.СуммаКорректировки, 0)) КАК КорректировкаСумма
    ИЗ
        Документ.КорректировкаРеализации КАК Корректировка
        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                Товары.Ссылка КАК Ссылка,
                Товары.Субконто КАК НоменклатурнаяГруппа,
                СУММА(ЕСТЬNULL(Товары.Количество, 0) - ЕСТЬNULL(Товары.КоличествоДоИзменения, 0)) КАК КоличествоКорректировки, // Чистое изменение количества
                СУММА(ЕСТЬNULL(Товары.Сумма, 0) - ЕСТЬNULL(Товары.СуммаДоИзменения, 0)) КАК СуммаКорректировки  // Чистое изменение суммы
            ИЗ
                Документ.КорректировкаРеализации.Товары КАК Товары
            СГРУППИРОВАТЬ ПО
                Товары.Ссылка,
                Товары.Субконто
        ) КАК КорректировкаТовары
        ПО Корректировка.Ссылка = КорректировкаТовары.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ (
            ВЫБРАТЬ
                Услуги.Ссылка КАК Ссылка,
                СУММА(ЕСТЬNULL(Услуги.Количество, 0) - ЕСТЬNULL(Услуги.КоличествоДоИзменения, 0)) КАК КоличествоКорректировки, // Чистое изменение количества
                СУММА(ЕСТЬNULL(Услуги.Сумма, 0) - ЕСТЬNULL(Услуги.СуммаДоИзменения, 0)) КАК СуммаКорректировки // Чистое изменение суммы
            ИЗ
                Документ.КорректировкаРеализации.Услуги КАК Услуги
            СГРУППИРОВАТЬ ПО
                Услуги.Ссылка
        ) КАК КорректировкаУслуги
        ПО Корректировка.Ссылка = КорректировкаУслуги.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг КАК Реализация
            ПО Корректировка.ДокументРеализации = Реализация.Ссылка
    ГДЕ
        Корректировка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    СГРУППИРОВАТЬ ПО
        НАЧАЛОПЕРИОДА(Корректировка.Дата, ДЕНЬ),
        КорректировкаТовары.НоменклатурнаяГруппа,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента) КАК Данные
СГРУППИРОВАТЬ ПО
    Данные.Дата,
    Данные.Контрагент,
    Данные.ДоговорКонтрагента,
    Данные.НоменклатурнаяГруппа
УПОРЯДОЧИТЬ ПО
    Дата,
    Контрагент,
    ДоговорКонтрагента
