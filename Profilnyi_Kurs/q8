ВЫБРАТЬ
    Ключи.Дата,
    Ключи.Контрагент,
    Ключи.ДоговорКонтрагента,
    Ключи.НоменклатурнаяГруппа,

    ЕСТЬNULL(План.ПланКоличество,0) КАК ПланКоличество,
    ЕСТЬNULL(План.ПланСумма,0) КАК ПланСумма,

    ЕСТЬNULL(Факт.ФактКоличество,0) КАК ФактКоличество,
    ЕСТЬNULL(Факт.ФактСумма,0) КАК ФактСумма

ИЗ
(
    // формируем все уникальные ключи из плана и факта
    ВЫБРАТЬ
        План.Дата КАК Дата,
        План.Контрагент КАК Контрагент,
        План.ДоговорКонтрагента КАК ДоговорКонтрагента,
        План.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа
    ИЗ
    (
        ВЫБРАТЬ
            Реализация.Дата,
            Реализация.Контрагент,
            Реализация.ДоговорКонтрагента,
            ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто) КАК НоменклатурнаяГруппа
        ИЗ
            Документ.РеализацияТоваровУслуг КАК Реализация
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
                ПО Реализация.Ссылка = РТУТовары.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
                ПО Реализация.Ссылка = РТУУслуг.Ссылка
        ГДЕ
            Реализация.Проведен
            И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
            И Реализация.Склад.Наименование ПОДОБНО "%Склад отгрузки готовой продукции%"
            И СОКРЛ(СОКРП(Реализация.ПодразделениеОрганизации.Код)) = "53"
        СГРУППИРОВАТЬ ПО
            Реализация.Дата,
            Реализация.Контрагент,
            Реализация.ДоговорКонтрагента,
            ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто)
    )
    ОБЪЕДИНИТЬ ВСЕ
    ВЫБРАТЬ
        ФактическиеДанные.Период,
        ФактическиеДанные.Контрагент,
        ФактическиеДанные.ДоговорКонтрагента,
        ФактическиеДанные.НоменклатурнаяГруппа
    ИЗ
        Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
    ГДЕ
        ФактическиеДанные.Ссылка.Проведен
        И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
        И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
        И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
        И ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[0-4][0-3]%"
) КАК Ключи

ЛЕВОЕ СОЕДИНЕНИЕ
(
    // План с суммами
    ВЫБРАТЬ
        Реализация.Дата,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто) КАК НоменклатурнаяГруппа,
        СУММА(ЕСТЬNULL(РТУТовары.Количество,0)+ЕСТЬNULL(РТУУслуг.Количество,0)) КАК ПланКоличество,
        СУММА(ЕСТЬNULL(РТУТовары.Сумма,0)+ЕСТЬNULL(РТУУслуг.Сумма,0)) КАК ПланСумма
    ИЗ
        Документ.РеализацияТоваровУслуг КАК Реализация
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТУТовары
            ПО Реализация.Ссылка = РТУТовары.Ссылка
        ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РТУУслуг
            ПО Реализация.Ссылка = РТУУслуг.Ссылка
    ГДЕ
        Реализация.Проведен
        И Реализация.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
        И Реализация.Склад.Наименование ПОДОБНО "%Склад отгрузки готовой продукции%"
        И СОКРЛ(СОКРП(Реализация.ПодразделениеОрганизации.Код)) = "53"
    СГРУППИРОВАТЬ ПО
        Реализация.Дата,
        Реализация.Контрагент,
        Реализация.ДоговорКонтрагента,
        ЕСТЬNULL(РТУТовары.Субконто, РТУУслуг.Субконто)
) КАК План
ПО
    Ключи.Дата = План.Дата
    И Ключи.Контрагент = План.Контрагент
    И Ключи.ДоговорКонтрагента = План.ДоговорКонтрагента
    И Ключи.НоменклатурнаяГруппа = План.НоменклатурнаяГруппа

ЛЕВОЕ СОЕДИНЕНИЕ
(
    // Факт с суммами
    ВЫБРАТЬ
        ФактическиеДанные.Период КАК Дата,
        ФактическиеДанные.Контрагент КАК Контрагент,
        ФактическиеДанные.ДоговорКонтрагента КАК ДоговорКонтрагента,
        ФактическиеДанные.НоменклатурнаяГруппа КАК НоменклатурнаяГруппа,
        СУММА(ФактическиеДанные.Количество) КАК ФактКоличество,
        СУММА(ФактическиеДанные.Сумма) КАК ФактСумма
    ИЗ
        Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК ФактическиеДанные
    ГДЕ
        ФактическиеДанные.Ссылка.Проведен
        И ФактическиеДанные.Период МЕЖДУ &ДатаНачала И &ДатаОкончания
        И ФактическиеДанные.Ссылка.Сценарий.Наименование = "ФАКТ"
        И ФактическиеДанные.СтатьяОборотов.ТипСтатьи = ЗНАЧЕНИЕ(Перечисление.бит_ТипыСтатейОборотов.БДР)
        И ФактическиеДанные.СтатьяОборотов.Кодификатор ПОДОБНО "11.42.0[0-4][0-3]%"
    СГРУППИРОВАТЬ ПО
        ФактическиеДанные.Период,
        ФактическиеДанные.Контрагент,
        ФактическиеДанные.ДоговорКонтрагента,
        ФактическиеДанные.НоменклатурнаяГруппа
) КАК Факт
ПО
    Ключи.Дата = Факт.Дата
    И Ключи.Контрагент = Факт.Контрагент
    И Ключи.ДоговорКонтрагента = Факт.ДоговорКонтрагента
    И Ключи.НоменклатурнаяГруппа = Факт.НоменклатурнаяГруппа
