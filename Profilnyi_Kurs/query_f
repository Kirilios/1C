ВЫБРАТЬ
    Итог.Дата,
    Итог.Контрагент,
    Итог.ДоговорКонтрагента,
    Итог.НоменклатурнаяГруппа,

    ЕСТЬNULL(Итог.РеализацияКоличество,0) КАК РеализацияКоличество,
    ЕСТЬNULL(Итог.РеализацияСумма,0)       КАК РеализацияСумма,

    ЕСТЬNULL(Итог.ФактКоличество,0)        КАК ФактКоличество,
    ЕСТЬNULL(Итог.ФактСумма,0)             КАК ФактСумма,

    ЕСТЬNULL(Итог.КорректировкаКоличество,0) КАК КорректировкаКоличество,
    ЕСТЬNULL(Итог.КорректировкаСумма,0)      КАК КорректировкаСумма

ИЗ
(
    // -----------------------------
    // 1. Универсальный набор ключей
    // -----------------------------
    ВЫБРАТЬ
        Дата,
        Контрагент,
        ДоговорКонтрагента,
        НоменклатурнаяГруппа,

        СУММА(РеализацияКоличество)       КАК РеализацияКоличество,
        СУММА(РеализацияСумма)            КАК РеализацияСумма,

        СУММА(ФактКоличество)             КАК ФактКоличество,
        СУММА(ФактСумма)                  КАК ФактСумма,

        СУММА(КоррКоличество)             КАК КорректировкаКоличество,
        СУММА(КоррСумма)                  КАК КорректировкаСумма

    ИЗ
    (
        // -----------------------------
        // Ключи + агрегаты Реализации
        // -----------------------------
        ВЫБРАТЬ
            НАЧАЛОПЕРИОДА(Р.Дата,ДЕНЬ) КАК Дата,
            Р.Контрагент,
            Р.ДоговорКонтрагента,
            ЕСТЬNULL(РТ.Субконто,РУ.Субконто) КАК НоменклатурнаяГруппа,
            СУММА(ВЫБОР
                    КОГДА ЕСТЬNULL(РТ.Сумма,0)>0 ТОГДА ЕСТЬNULL(РТ.Количество,0) ИНАЧЕ 0 КОНЕЦ
                 + ЕСТЬNULL(РУ.Количество,0)) КАК РеализацияКоличество,
            СУММА(ЕСТЬNULL(РТ.Сумма,0)+ЕСТЬNULL(РУ.Сумма,0)) КАК РеализацияСумма,
            0 КАК ФактКоличество,
            0 КАК ФактСумма,
            0 КАК КоррКоличество,
            0 КАК КоррСумма
        ИЗ Документ.РеализацияТоваровУслуг КАК Р
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РТ
                ПО Р.Ссылка = РТ.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Услуги КАК РУ
                ПО Р.Ссылка = РУ.Ссылка
        ГДЕ
            Р.Проведен
        СГРУППИРОВАТЬ ПО
            НАЧАЛОПЕРИОДА(Р.Дата,ДЕНЬ),
            Р.Контрагент,
            Р.ДоговорКонтрагента,
            ЕСТЬNULL(РТ.Субконто,РУ.Субконто)

        ОБЪЕДИНИТЬ ВСЕ

        // -----------------------------
        // Агрегаты Факта
        // -----------------------------
        ВЫБРАТЬ
            НАЧАЛОПЕРИОДА(Ф. Период,ДЕНЬ) КАК Дата,
            Ф.Контрагент,
            Ф.ДоговорКонтрагента,
            Ф.НоменклатурнаяГруппа,
            0 КАК РеализацияКоличество,
            0 КАК РеализацияСумма,
            СУММА(Ф.Количество) КАК ФактКоличество,
            СУММА(Ф.Сумма) КАК ФактСумма,
            0 КАК КоррКоличество,
            0 КАК КоррСумма
        ИЗ Документ.бит_ПолучениеФактическихДанных.ФактическиеДанные КАК Ф
        ГДЕ
            Ф.Ссылка.Проведен
        СГРУППИРОВАТЬ ПО
            НАЧАЛОПЕРИОДА(Ф.Период,ДЕНЬ),
            Ф.Контрагент,
            Ф.ДоговорКонтрагента,
            Ф.НоменклатурнаяГруппа

        ОБЪЕДИНИТЬ ВСЕ

        // -----------------------------
        // Агрегаты Корректировок
        // -----------------------------
        ВЫБРАТЬ
            НАЧАЛОПЕРИОДА(К.Дата,ДЕНЬ) КАК Дата,
            К.Контрагент,
            К.ДоговорКонтрагента,
            ЕСТЬNULL(КТ.НоменклатурнаяГруппа, КУ.НоменклатурнаяГруппа) КАК НоменклатурнаяГруппа,
            0 КАК РеализацияКоличество,
            0 КАК РеализацияСумма,
            0 КАК ФактКоличество,
            0 КАК ФактСумма,
            СУММА(ВЫБОР
                    КОГДА ЕСТЬNULL(КУ.Количество,0)>0 ТОГДА ЕСТЬNULL(КУ.Количество,0) ИНАЧЕ ЕСТЬNULL(КТ.Количество,0) КОНЕЦ
            ) КАК КоррКоличество,
            СУММА(ВЫБОР
                    КОГДА ЕСТЬNULL(КУ.Сумма,0)>0 ТОГДА ЕСТЬNULL(КУ.Сумма,0) ИНАЧЕ ЕСТЬNULL(КТ.Сумма,0) КОНЕЦ
            ) КАК КоррСумма
        ИЗ Документ.КорректировкаРеализации КАК К
            ЛЕВОЕ СОЕДИНЕНИЕ
                (ВЫБРАТЬ
                     Т.Ссылка,
                     Т.Субконто КАК НоменклатурнаяГруппа,
                     СУММА(Т.Количество) КАК Количество,
                     СУММА(Т.Сумма) КАК Сумма
                 ИЗ Документ.КорректировкаРеализации.Товары КАК Т
                 СГРУППИРОВАТЬ ПО Т.Ссылка, Т.Субконто
                ) КАК КТ
                ПО К.Ссылка = КТ.Ссылка
            ЛЕВОЕ СОЕДИНЕНИЕ
                (ВЫБРАТЬ
                     У.Ссылка,
                     У.НоменклатурнаяГруппа,
                     СУММА(У.Количество) КАК Количество,
                     СУММА(У.Сумма) КАК Сумма
                 ИЗ Документ.КорректировкаРеализации.Услуги КАК У
                 СГРУППИРОВАТЬ ПО У.Ссылка, У.НоменклатурнаяГруппа
                ) КАК КУ
                ПО К.Ссылка = КУ.Ссылка
        СГРУППИРОВАТЬ ПО
            НАЧАЛОПЕРИОДА(К.Дата,ДЕНЬ),
            К.Контрагент,
            К.ДоговорКонтрагента,
            ЕСТЬNULL(КТ.НоменклатурнаяГруппа, КУ.НоменклатурнаяГруппа)
    ) КАК Src
    СГРУППИРОВАТЬ ПО
        Дата,
        Контрагент,
        ДоговорКонтрагента,
        НоменклатурнаяГруппа
) КАК Итог

УПОРЯДОЧИТЬ ПО
    Итог.Дата,
    Итог.Контрагент,
    Итог.ДоговорКонтрагента;
