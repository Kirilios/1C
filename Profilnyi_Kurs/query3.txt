ВЫБРАТЬ
   РеализацияТоваровУслугТовары.Ссылка КАК Документ,
   РеализацияТоваровУслугТовары.Ссылка.Контрагент КАК Контрагент,
   РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента КАК Договор,
   РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности КАК НаправлениеДеятельности,
   СОКРЛП(РеализацияТоваровУслугТовары.Ссылка.Номер) КАК Номер,
   РеализацияТоваровУслугТовары.Ссылка.Дата КАК Дата,
   ПОДСТРОКА(РеализацияТоваровУслугТовары.Ссылка.Склад.Наименование, 0, 3) КАК Склад,
   РеализацияТоваровУслугТовары.Номенклатура.Наименование КАК Изделие,
   РеализацияТоваровУслугТовары.Количество КАК Количество,
   ВЫБОР
    КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0) = 0
       ТОГДА РеализацияТоваровУслугТовары.Цена * ЕСТЬNULL(РеализацияТоваровУслугТовары.Ссылка.КурсВзаиморасчетов, 1)
            ИНАЧЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС / РеализацияТоваровУслугТовары.Количество
       КОНЕЦ КАК Цена,
        ВЫБОР
      КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0) = 0
                               ТОГДА РеализацияТоваровУслугТовары.Сумма + РеализацияТоваровУслугТовары.СуммаНДС
                           ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0)
                       КОНЕЦ КАК Сумма,
                       ВЫБОР
                           КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС, 0) = 0
                               ТОГДА ЕСТЬNULL(РеализацияТоваровУслугТовары.СуммаНДС, 0)
                           ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС, 0)
                       КОНЕЦ КАК СуммаНДС,
                       ВЫБОР
                           КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС, 0) = 0
                               ТОГДА РеализацияТоваровУслугТовары.Количество * РеализацияТоваровУслугТовары.Цена
                           ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС, 0)
                       КОНЕЦ КАК СуммаБезНДС,
                       РеализацияТоваровУслугТовары.ЕдиницаИзмерения КАК ЕдиницаИзмерения,
                       ВЫБОР
                           КОГДА РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""1%""
                               ТОГДА ""ГОЗ (Поставка)""
                           КОГДА РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""2%""
                               ТОГДА ""ГОЗ (Ремонт)""
                           КОГДА РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""Р%""
                               ТОГДА ""Прочее (Ремонт)""
                           КОГДА РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""К%""
                               ТОГДА ""Прочее (Поставка)""
                           ИНАЧЕ ""Не распределено""
                       КОНЕЦ КАК Вариант,
                       РеализацияТоваровУслугТовары.Субконто КАК Субконто,
                       ВЫБОР
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""1""
                               ТОГДА ""Военный""
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугТовары.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""2""
                               ТОГДА ""Гражданский""
                       КОНЕЦ КАК ТипПродукции,
                       РеализацияТоваровУслугТовары.Субконто КАК НоменклатураНоменклатурнаяГруппа
                   ПОМЕСТИТЬ ВТРеализаций
                   ИЗ
                       Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
                           ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
                           ПО РеализацияТоваровУслугТовары.Ссылка = РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор
                               И РеализацияТоваровУслугТовары.НомерСтроки = РегистрСведенийРублевыеСуммыДокументовВВалюте.НомерСтрокиДокумента
                               И (РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.Товары))
                   ГДЕ
                       РеализацияТоваровУслугТовары.Ссылка.Проведен
                       И РеализацияТоваровУслугТовары.Ссылка.Дата МЕЖДУ &НачалоПериода И &КонецПериода
                       И РеализацияТоваровУслугТовары.Ссылка.Склад.Наименование ПОДОБНО ""%Склад отгрузки готовой продукции%""
                       И РеализацияТоваровУслугТовары.Номенклатура.ВидНоменклатуры <> &ВидНоменклатуры
                       И РеализацияТоваровУслугТовары.Цена <> 0
                   
                   ОБЪЕДИНИТЬ ВСЕ
                   
                   ВЫБРАТЬ
                       РеализацияТоваровУслугУслуги.Ссылка,
                       РеализацияТоваровУслугУслуги.Ссылка.Контрагент,
                       РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента,
                       РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности,
                       СОКРЛП(РеализацияТоваровУслугУслуги.Ссылка.Номер),
                       РеализацияТоваровУслугУслуги.Ссылка.Дата,
                       ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.Склад.Наименование, 0, 3),
                       РеализацияТоваровУслугУслуги.Номенклатура.Наименование,
                       СУММА(РеализацияТоваровУслугУслуги.Количество),
                       СУММА(ВЫБОР
                               КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0) = 0
                                   ТОГДА РеализацияТоваровУслугУслуги.Цена * ЕСТЬNULL(РеализацияТоваровУслугУслуги.Ссылка.КурсВзаиморасчетов, 1)
                               ИНАЧЕ РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС / РеализацияТоваровУслугУслуги.Количество
                           КОНЕЦ),
                       СУММА(ВЫБОР
                               КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0) = 0
                                   ТОГДА РеализацияТоваровУслугУслуги.Сумма + РеализацияТоваровУслугУслуги.СуммаНДС
                               ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.Всего, 0)
                           КОНЕЦ),
                       СУММА(ВЫБОР
                               КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС, 0) = 0
                                   ТОГДА ЕСТЬNULL(РеализацияТоваровУслугУслуги.СуммаНДС, 0)
                               ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НДС, 0)
                           КОНЕЦ),
                       СУММА(ВЫБОР
                               КОГДА ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС, 0) = 0
                                   ТОГДА РеализацияТоваровУслугУслуги.Количество * РеализацияТоваровУслугУслуги.Цена
                               ИНАЧЕ ЕСТЬNULL(РегистрСведенийРублевыеСуммыДокументовВВалюте.НалоговаяБазаНДС, 0)
                           КОНЕЦ),
                       NULL,
                       ВЫБОР
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""1%""
                               ТОГДА ""ГОЗ (Поставка)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""2%""
                               ТОГДА ""ГОЗ (Ремонт)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""Р%""
                               ТОГДА ""Прочее (Ремонт)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""К%""
                               ТОГДА ""Прочее (Поставка)""
                           ИНАЧЕ ""Не распределено""
                       КОНЕЦ,
                       РеализацияТоваровУслугУслуги.Субконто,
                       ВЫБОР
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""1""
                               ТОГДА ""Военный""
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""2""
                               ТОГДА ""Гражданский""
                       КОНЕЦ,
                       РеализацияТоваровУслугУслуги.Субконто
                   ИЗ
                       Документ.РеализацияТоваровУслуг.Услуги КАК РеализацияТоваровУслугУслуги
                           ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РублевыеСуммыДокументовВВалюте КАК РегистрСведенийРублевыеСуммыДокументовВВалюте
                           ПО РеализацияТоваровУслугУслуги.Ссылка = РегистрСведенийРублевыеСуммыДокументовВВалюте.Регистратор
                               И РеализацияТоваровУслугУслуги.НомерСтроки = РегистрСведенийРублевыеСуммыДокументовВВалюте.НомерСтрокиДокумента
                               И (РегистрСведенийРублевыеСуммыДокументовВВалюте.ТабличнаяЧастьДокумента = ЗНАЧЕНИЕ(Перечисление.ТабличныеЧастиДокументов.Услуги))
                   ГДЕ
                       РеализацияТоваровУслугУслуги.Ссылка.Проведен
                       И РеализацияТоваровУслугУслуги.Ссылка.Дата МЕЖДУ &НачалоПериода И &КонецПериода
                       И РеализацияТоваровУслугУслуги.Номенклатура.ВидНоменклатуры <> &ВидНоменклатуры
                       И РеализацияТоваровУслугУслуги.Сумма <> 0
                       И (РеализацияТоваровУслугУслуги.Ссылка.ПодразделениеОрганизации.Наименование ПОДОБНО ""%Цех №%""
                                   И НЕ РеализацияТоваровУслугУслуги.Ссылка.ПодразделениеОрганизации.Наименование ПОДОБНО ""%19%""
                               ИЛИ РеализацияТоваровУслугУслуги.Ссылка.ПодразделениеОрганизации.Наименование ПОДОБНО ""ОС""
                               ИЛИ РеализацияТоваровУслугУслуги.Ссылка.ga_Ремонтный)
                   
                   СГРУППИРОВАТЬ ПО
                       РеализацияТоваровУслугУслуги.Ссылка,
                       РеализацияТоваровУслугУслуги.Номенклатура.Наименование,
                       РеализацияТоваровУслугУслуги.Ссылка.Контрагент,
                       РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента,
                       РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности,
                       СОКРЛП(РеализацияТоваровУслугУслуги.Ссылка.Номер),
                       РеализацияТоваровУслугУслуги.Ссылка.Дата,
                       ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.Склад.Наименование, 0, 3),
                       ВЫБОР
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""1%""
                               ТОГДА ""ГОЗ (Поставка)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""2%""
                               ТОГДА ""ГОЗ (Ремонт)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""Р%""
                               ТОГДА ""Прочее (Ремонт)""
                           КОГДА РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.Наименование ПОДОБНО ""К%""
                               ТОГДА ""Прочее (Поставка)""
                           ИНАЧЕ ""Не распределено""
                       КОНЕЦ,
                       РеализацияТоваровУслугУслуги.Субконто,
                       ВЫБОР
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""1""
                               ТОГДА ""Военный""
                           КОГДА ПОДСТРОКА(РеализацияТоваровУслугУслуги.Ссылка.ДоговорКонтрагента.ga_НаправлениеДеятельности.СтатьяБСР.Наименование, 9, 1) = ""2""
                               ТОГДА ""Гражданский""
                       КОНЕЦ,
                       РеализацияТоваровУслугУслуги.Субконто
                   ;
